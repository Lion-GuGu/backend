<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Gugu 임시 테스트(등록+조회)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
        body { margin: 20px; }
        h1 { margin: 0 0 16px; }
        fieldset { margin: 12px 0 20px; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; }
        legend { padding: 0 6px; font-weight: 600; }
        label { display:inline-block; min-width:120px; }
        input, select, button, textarea { padding: 6px 8px; margin: 4px 0; }
        input[type="number"] { width: 140px; }
        input[type="date"], input[type="time"] { width: 170px; }
        textarea { width: 100%; }
        .row { display:flex; gap:12px; flex-wrap: wrap; align-items: center; }
        .small { font-size:12px; color:#666; }
        pre { background:#0b1020; color:#d7eaff; padding:12px; border-radius:8px; overflow:auto; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; }
        th { background: #f5f7fa; text-align: left; }
        .two { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
        @media (max-width: 1100px){ .two{ grid-template-columns:1fr; } }
        .ok { color:#059669; }
        .err { color:#dc2626; }
        .divider { height:1px; background:#eee; margin:8px 0 4px; }
    </style>
</head>
<body>
<h1>Gugu 임시 테스트</h1>
<div class="small">컨트롤러 경로에 맞춰 회원가입/케어요청 등록과 조회를 빠르게 테스트.</div>

<fieldset>
    <legend>환경</legend>
    <div class="row">
        <label for="baseUrl">API Base URL</label>
        <input id="baseUrl" type="text" value="http://15.164.169.237:8080" style="width:380px" />
        <button id="ping">서버 상태 체크</button>
        <span id="pingMsg" class="small"></span>
    </div>
    <div class="small">※ CSRF가 켜져 있으면 쿠키의 XSRF-TOKEN을 자동으로 읽어 헤더(X-XSRF-TOKEN)에 실어 보냅니다.</div>
</fieldset>

<div class="two">
    <!-- 회원가입 + 조회 -->
    <fieldset>
        <legend>회원 (Auth)</legend>

        <div class="row"><strong>등록 (POST /api/auth/signup)</strong></div>
        <div class="row">
            <label for="suUsername">username</label><input id="suUsername" placeholder="예: alice01" />
            <label for="suPassword">password</label><input id="suPassword" type="password" placeholder="평문 → 서버에서 해시" />
        </div>
        <div class="row">
            <label for="suName">name</label><input id="suName" placeholder="예: Alice Kim" />
            <label for="suEmail">email</label><input id="suEmail" type="email" placeholder="예: alice@example.com" style="width:260px" />
        </div>
        <div class="row">
            <button id="btnSignup">등록</button>
            <span id="suMsg" class="small"></span>
        </div>

        <div class="divider"></div>

        <div class="row"><strong>조회</strong></div>
        <div class="row">
            <button id="btnUsersAll">GET /api/auth/users</button>
            <label for="uId">id</label><input id="uId" type="number" min="1" placeholder="예: 1" />
            <button id="btnUserOne">GET /api/auth/users/{id}</button>
        </div>
        <div id="usersTableWrap"></div>
    </fieldset>

    <!-- 케어요청 + 조회 -->
    <fieldset>
        <legend>케어요청 (Requests)</legend>

        <div class="row"><strong>등록 (POST /api/requests?parentId=...)</strong></div>
        <div class="row">
            <label for="crParentId">parentId(쿼리)</label><input id="crParentId" type="number" min="1" placeholder="회원 id" />
        </div>
        <div class="row">
            <label for="crTitle">title</label><input id="crTitle" placeholder="예: 하교 픽업 부탁" style="width:280px" />
        </div>
        <div class="row">
            <label for="crCategory">category</label>
            <select id="crCategory">
                <option value="긴급">긴급</option><option value="돌봄" selected>돌봄</option>
                <option value="교육">교육</option><option value="기타">기타</option>
            </select>
            <label for="crGender">child_gender</label>
            <select id="crGender"><option value="MALE">MALE</option><option value="FEMALE">FEMALE</option></select>
            <label for="crAge">child_age</label><input id="crAge" type="number" min="0" placeholder="예: 7" />
        </div>
        <div class="row">
            <label for="crDateOnly">date_only</label><input id="crDateOnly" type="date" />
            <label for="crStart">start_time</label><input id="crStart" type="time" />
            <label for="crEnd">end_time</label><input id="crEnd" type="time" />
        </div>
        <div class="row">
            <label for="crLocation">location</label><input id="crLocation" placeholder="예: 서울 성북구 ○○초 정문" style="width:320px" />
        </div>
        <div>
            <label for="crDesc">description</label>
            <textarea id="crDesc" rows="3" placeholder="요청 상세 (알레르기 등)"></textarea>
        </div>
        <div class="row">
            <label for="crTags">tags(쉼표로 구분)</label>
            <input id="crTags" placeholder="예: 등하교,수학" style="width:280px" />
        </div>
        <div class="row">
            <button id="btnCreateCR">등록</button>
            <span id="crMsg" class="small"></span>
        </div>

        <div class="divider"></div>

        <div class="row"><strong>조회</strong></div>
        <div class="row">
            <button id="btnCRAll">GET /api/requests</button>
            <label for="crIdOne">id</label><input id="crIdOne" type="number" min="1" placeholder="예: 1" />
            <button id="btnCROne">GET /api/requests/{id}</button>
        </div>
        <div id="crTableWrap"></div>
    </fieldset>
</div>

<fieldset>
    <legend>원시 응답(JSON) + 상태코드</legend>
    <pre id="raw"></pre>
</fieldset>

<script>
    const $ = (id) => document.getElementById(id);
    const raw = $("raw");

    const path = {
        signup: "/api/auth/signup",
        usersAll: "/api/auth/users",
        userOne: (id) => `/api/auth/users/${id}`,
        crAll: "/api/requests",
        crOne: (id) => `/api/requests/${id}`,
        crCreate: (parentId) => `/api/requests?parentId=${encodeURIComponent(parentId)}`
    };

    function base() { return $("baseUrl").value.replace(/\/+$/, ""); }
    function showRaw(obj, status) {
        raw.textContent = JSON.stringify({ status, body: obj }, null, 2);
    }

    // CSRF: 쿠키 XSRF-TOKEN → 헤더
    function getCookie(name){
        return document.cookie.split('; ').find(row => row.startsWith(name+'='))?.split('=')[1];
    }

    async function getJson(url) {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = text; }
        showRaw(data, res.status);
        if (!res.ok) throw { status: res.status, data };
        return data;
    }

    async function postJson(url, body) {
        const headers = { "Content-Type": "application/json", "Accept": "application/json" };
        const csrf = getCookie("XSRF-TOKEN");
        if (csrf) headers["X-XSRF-TOKEN"] = csrf;

        const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = text; }
        showRaw(data, res.status);
        if (!res.ok) throw { status: res.status, data };
        return data;
    }

    function renderTable(containerId, rows, columns) {
        const wrap = $(containerId);
        if (!Array.isArray(rows)) { wrap.innerHTML = "<div class='small'>배열 응답이 아님</div>"; return; }
        if (!rows.length) { wrap.innerHTML = "<div class='small'>데이터 없음</div>"; return; }
        const ths = columns.map(c => `<th>${c.header}</th>`).join("");
        const trs = rows.map(r => {
            const tds = columns.map(c => `<td>${c.render ? c.render(r) : (r[c.key] ?? "")}</td>`).join("");
            return `<tr>${tds}</tr>`;
        }).join("");
        wrap.innerHTML = `<table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    // 핑
    $("ping").addEventListener("click", async () => {
        $("pingMsg").textContent = "요청 중…";
        try {
            const res = await fetch(base() + "/", { method: "GET" });
            $("pingMsg").textContent = `응답: ${res.status}`; $("pingMsg").className = "small ok";
        } catch { $("pingMsg").textContent = "연결 실패"; $("pingMsg").className = "small err"; }
    });

    // 회원가입
    $("btnSignup").addEventListener("click", async () => {
        const username = $("suUsername").value.trim();
        const password = $("suPassword").value;
        const name = $("suName").value.trim();
        const email = $("suEmail").value.trim();
        if (!username || !password || !name || !email) {
            $("suMsg").textContent = "username/password/name/email 필수"; $("suMsg").className = "small err"; return;
        }
        try {
            const data = await postJson(base() + path.signup, { username, password, name, email });
            $("suMsg").textContent = `등록 완료 (id: ${data?.id ?? "확인"})`; $("suMsg").className = "small ok";
        } catch (e) {
            $("suMsg").textContent = `등록 실패 (status ${e.status ?? "?"})`; $("suMsg").className = "small err";
        }
    });

    // 회원 조회
    $("btnUsersAll").addEventListener("click", async () => {
        const data = await getJson(base() + path.usersAll);
        renderTable("usersTableWrap", Array.isArray(data) ? data : (data.content || data.items || []), [
            { header: "id", key: "id" },
            { header: "username", key: "username" },
            { header: "name", key: "name" },
            { header: "email", key: "email" }
        ]);
    });
    $("btnUserOne").addEventListener("click", async () => {
        const id = $("uId").value;
        if (!id) return alert("id 입력");
        await getJson(base() + path.userOne(id)); // 단건은 raw로만 확인
    });

    // 케어요청 등록
    $("btnCreateCR").addEventListener("click", async () => {
        const parentId = Number($("crParentId").value);
        const title = $("crTitle").value.trim();
        const category = $("crCategory").value;
        const date_only = $("crDateOnly").value;
        const start_time = $("crStart").value;
        const end_time = $("crEnd").value;
        const child_gender = $("crGender").value;
        const child_age = $("crAge").value ? Number($("crAge").value) : null;
        const location = $("crLocation").value.trim();
        const description = $("crDesc").value.trim();
        const tags = $("crTags").value.trim()
            ? $("crTags").value.split(",").map(s => s.trim()).filter(Boolean)
            : null;

        if (!parentId || !title || !category || !date_only || !start_time || !end_time || !child_gender || child_age === null) {
            $("crMsg").textContent = "필수값 확인!"; $("crMsg").className = "small err"; return;
        }

        const body = { title, category, dateOnly: date_only, startTime: start_time, endTime: end_time,
            location: location || null, childGender: child_gender, childAge: child_age,
            description: description || null, tags };

        try {
            const data = await postJson(base() + path.crCreate(parentId), body);
            $("crMsg").textContent = `등록 완료 (id: ${data?.id ?? "확인"})`; $("crMsg").className = "small ok";
        } catch (e) {
            $("crMsg").textContent = `등록 실패 (status ${e.status ?? "?"})`; $("crMsg").className = "small err";
        }
    });

    // 케어요청 조회
    $("btnCRAll").addEventListener("click", async () => {
        const data = await getJson(base() + path.crAll);
        renderTable("crTableWrap", Array.isArray(data) ? data : (data.content || data.items || []), [
            { header: "id", key: "id" },
            { header: "parent_id", key: "parent_id" },
            { header: "title", key: "title" },
            { header: "category", key: "category" },
            { header: "date_only", key: "date_only" },
            { header: "start_time", key: "start_time" },
            { header: "end_time", key: "end_time" },
            { header: "status", key: "status" }
        ]);
    });
    $("btnCROne").addEventListener("click", async () => {
        const id = $("crIdOne").value;
        if (!id) return alert("id 입력");
        await getJson(base() + path.crOne(id));
    });
</script>
</body>
</html>
